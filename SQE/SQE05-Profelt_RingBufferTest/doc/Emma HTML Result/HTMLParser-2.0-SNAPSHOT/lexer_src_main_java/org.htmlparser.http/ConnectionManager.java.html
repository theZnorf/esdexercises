<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>ConnectionManager.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (4) (Oct 27, 2015 3:17:09 PM)</a> &gt; <a href="../../index.html" class="el_group">HTMLParser-2.0-SNAPSHOT</a> &gt; <a href="../index.html" class="el_bundle">lexer/src/main/java</a> &gt; <a href="index.source.html" class="el_package">org.htmlparser.http</a> &gt; <span class="el_source">ConnectionManager.java</span></div><h1>ConnectionManager.java</h1><pre class="source lang-java linenums">// HTMLParser Library - A java-based parser for HTML
// http://htmlparser.org
// Copyright (C) 2006 Derrick Oswald
//
// Revision Control Information
//
// $URL: https://svn.sourceforge.net/svnroot/htmlparser/trunk/lexer/src/main/java/org/htmlparser/http/ConnectionManager.java $
// $Author: derrickoswald $
// $Date: 2006-09-16 10:44:17 -0400 (Sat, 16 Sep 2006) $
// $Revision: 4 $
//
// This library is free software; you can redistribute it and/or
// modify it under the terms of the Common Public License; either
// version 1.0 of the License, or (at your option) any later version.
//
// This library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// Common Public License for more details.
//
// You should have received a copy of the Common Public License
// along with this library; if not, the license is available from
// the Open Source Initiative (OSI) website:
//   http://opensource.org/licenses/cpl1.0.php

package org.htmlparser.http;

import java.io.File;
import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.net.UnknownHostException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Properties;
import java.util.StringTokenizer;
import java.util.Vector;

import org.htmlparser.util.ParserException;

/**
 * Handles proxies, password protected URLs and request properties
 * including cookies.
 */
public class ConnectionManager
{
    /**
     * Default Request header fields.
     * So far this is just &quot;User-Agent&quot; and &quot;Accept-Encoding&quot;.
     */
<span class="fc" id="L56">    protected static Hashtable mDefaultRequestProperties = new Hashtable ();</span>
    static
    {
<span class="fc" id="L59">        mDefaultRequestProperties.put (&quot;User-Agent&quot;, &quot;HTMLParser/&quot;</span>
            + org.htmlparser.lexer.Lexer.VERSION_NUMBER);
<span class="fc" id="L61">        mDefaultRequestProperties.put (&quot;Accept-Encoding&quot;, &quot;gzip, deflate&quot;);</span>
    }

    /**
     * Messages for page not there (404).
     */
<span class="fc" id="L67">    private static final String[] FOUR_OH_FOUR =</span>
<span class="fc" id="L68">    {</span>
<span class="fc" id="L69">        &quot;The web site you seek cannot be located,&quot;</span>
            + &quot; but countless more exist&quot;,
<span class="fc" id="L71">        &quot;You step in the stream, but the water has moved on.&quot;</span>
            + &quot; This page is not here.&quot;,
<span class="fc" id="L73">        &quot;Yesterday the page existed. Today it does not.&quot;</span>
            + &quot; The internet is like that.&quot;,
<span class="fc" id="L75">        &quot;That page was so big. It might have been very useful.&quot;</span>
            + &quot; But now it is gone.&quot;,
<span class="fc" id="L77">        &quot;Three things are certain: death, taxes and broken links.&quot;</span>
            + &quot; Guess which has occured.&quot;,
<span class="fc" id="L79">        &quot;Chaos reigns within. Reflect, repent and enter the correct URL.&quot;</span>
            + &quot; Order shall return.&quot;,
<span class="fc" id="L81">        &quot;Stay the patient course. Of little worth is your ire.&quot;</span>
            + &quot; The page is not found.&quot;,
<span class="fc" id="L83">        &quot;A non-existant URL reduces your expensive computer to a simple stone.&quot;,</span>
<span class="fc" id="L84">        &quot;Many people have visited that page.&quot;</span>
            + &quot; Today, you are not one of the lucky ones.&quot;,
<span class="fc" id="L86">        &quot;Cutting the wind with a knife. Bookmarking a URL.&quot;</span>
            + &quot; Both are ephemeral.&quot;,
    };

    /**
     * Base 64 character translation table.
     */
<span class="fc" id="L93">    private static final char[] BASE64_CHAR_TABLE =</span>
<span class="fc" id="L94">         (&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
<span class="fc" id="L95">        + &quot;abcdefghijklmnopqrstuvwxyz0123456789+/&quot;).toCharArray ();</span>

    /**
     * Request header fields.
     */
    protected Hashtable mRequestProperties;

    /**
     * The proxy server name.
     */
    protected String mProxyHost;

    /**
     * The proxy port number.
     */
    protected int mProxyPort;

    /**
     * The proxy username name.
     */
    protected String mProxyUser;

    /**
     * The proxy user password.
     */
    protected String mProxyPassword;

    /**
     * The username name for accessing the URL.
     */
    protected String mUser;

    /**
     * The user password for accessing the URL.
     */
    protected String mPassword;

    /**
     * Cookie storage, a hashtable (by site or host) of vectors of Cookies.
     * This will be null if cookie processing is disabled (default).
     */
    protected Hashtable mCookieJar;

    /**
     * The object to be notified prior to and after each connection.
     */
    protected ConnectionMonitor mMonitor;

    /**
     * Flag determining if redirection processing is being handled manually.
     */
    protected boolean mRedirectionProcessingEnabled;

    /**
     * Cookie expiry date format for parsing.
     */
<span class="fc" id="L151">    static protected SimpleDateFormat mFormat =</span>
<span class="fc" id="L152">        new SimpleDateFormat (&quot;EEE, dd-MMM-yy kk:mm:ss z&quot;);</span>

    /**
     * Create a connection manager.
     */
    public ConnectionManager ()
    {
<span class="fc" id="L159">        this (getDefaultRequestProperties ());</span>
<span class="fc" id="L160">    }</span>

    /**
     * Create a connection manager with the given connection properties.
     * @param properties Name/value pairs to be added to the HTTP request.
     */
<span class="fc" id="L166">    public ConnectionManager (Hashtable properties)</span>
    {
<span class="fc" id="L168">        mRequestProperties = properties;</span>
<span class="fc" id="L169">        mProxyHost = null;</span>
<span class="fc" id="L170">        mProxyPort = 0;</span>
<span class="fc" id="L171">        mProxyUser = null;</span>
<span class="fc" id="L172">        mProxyPassword = null;</span>
<span class="fc" id="L173">        mUser = null;</span>
<span class="fc" id="L174">        mPassword = null;</span>
<span class="fc" id="L175">        mCookieJar = null;</span>
<span class="fc" id="L176">        mMonitor = null;</span>
<span class="fc" id="L177">        mRedirectionProcessingEnabled = false;</span>
<span class="fc" id="L178">    }</span>

    //
    // static methods
    //

    /**
     * Get the current default request header properties.
     * A String-to-String map of header keys and values.
     * These fields are set by the parser when creating a connection.
     * @return The default set of request header properties that will
     * currently be used.
     * @see #mDefaultRequestProperties
     * @see #setRequestProperties
     */
    public static Hashtable getDefaultRequestProperties ()
    {
<span class="fc" id="L195">        return (mDefaultRequestProperties);</span>
    }

    /**
     * Set the default request header properties.
     * A String-to-String map of header keys and values.
     * These fields are set by the parser when creating a connection.
     * Some of these can be set directly on a &lt;code&gt;URLConnection&lt;/code&gt;,
     * i.e. If-Modified-Since is set with setIfModifiedSince(long),
     * but since the parser transparently opens the connection on behalf
     * of the developer, these properties are not available before the
     * connection is fetched. Setting these request header fields affects all
     * subsequent connections opened by the parser. For more direct control
     * create a &lt;code&gt;URLConnection&lt;/code&gt; massage it the way you want and
     * then set it on the parser.&lt;p&gt;
     * From &lt;a href=&quot;http://www.ietf.org/rfc/rfc2616.txt&quot;&gt;
     * RFC 2616 Hypertext Transfer Protocol -- HTTP/1.1&lt;/a&gt;: 
     * &lt;pre&gt;
     * 5.3 Request Header Fields
     *
     *    The request-header fields allow the client to pass additional
     *    information about the request, and about the client itself, to the
     *    server. These fields act as request modifiers, with semantics
     *    equivalent to the parameters on a programming language method
     *    invocation.
     *
     *        request-header = Accept                   ; Section 14.1
     *                       | Accept-Charset           ; Section 14.2
     *                       | Accept-Encoding          ; Section 14.3
     *                       | Accept-Language          ; Section 14.4
     *                       | Authorization            ; Section 14.8
     *                       | Expect                   ; Section 14.20
     *                       | From                     ; Section 14.22
     *                       | Host                     ; Section 14.23
     *                       | If-Match                 ; Section 14.24
     *                       | If-Modified-Since        ; Section 14.25
     *                       | If-None-Match            ; Section 14.26
     *                       | If-Range                 ; Section 14.27
     *                       | If-Unmodified-Since      ; Section 14.28
     *                       | Max-Forwards             ; Section 14.31
     *                       | Proxy-Authorization      ; Section 14.34
     *                       | Range                    ; Section 14.35
     *                       | Referer                  ; Section 14.36
     *                       | TE                       ; Section 14.39
     *                       | User-Agent               ; Section 14.43
     *
     *    Request-header field names can be extended reliably only in
     *    combination with a change in the protocol version. However, new or
     *    experimental header fields MAY be given the semantics of request-
     *    header fields if all parties in the communication recognize them to
     *    be request-header fields. Unrecognized header fields are treated as
     *    entity-header fields.
     * &lt;/pre&gt;
     * @param properties The new set of default request header properties to
     * use. This affects all subsequently created connections.
     * @see #mDefaultRequestProperties
     * @see #setRequestProperties
     */
    public static void setDefaultRequestProperties (Hashtable properties)
    {
<span class="nc" id="L255">        mDefaultRequestProperties = properties;</span>
<span class="nc" id="L256">    }</span>

    /**
     * Get the current request header properties.
     * A String-to-String map of header keys and values,
     * excluding proxy items, cookies and URL authorization.
     * @return The request header properties for this connection manager.
     */
    public Hashtable getRequestProperties ()
    {
<span class="fc" id="L266">        return (mRequestProperties);</span>
    }

    /**
     * Set the current request properties.
     * Replaces the current set of fixed request properties with the given set.
     * This does not replace the Proxy-Authorization property which is
     * constructed from the values of {@link #setProxyUser}
     * and {@link #setProxyPassword} values or the Authorization property
     * which is constructed from the {@link #setUser}
     * and {@link #setPassword} values. Nor does it replace the
     * Cookie property which is constructed from the current cookie jar.
     * @param properties The new fixed properties.
     */
    public void setRequestProperties (Hashtable properties)
    {
<span class="nc" id="L282">        mRequestProperties = properties;</span>
<span class="nc" id="L283">    }</span>

    /**
     * Get the proxy host name, if any.
     * @return Returns the proxy host.
     */
    public String getProxyHost ()
    {
<span class="fc" id="L291">        return (mProxyHost);</span>
    }

    /**
     * Set the proxy host to use.
     * @param host The host to use for proxy access.
     * &lt;em&gt;Note: You must also set the proxy {@link #setProxyPort port}.&lt;/em&gt;
     */
    public void setProxyHost (String host)
    {
<span class="nc" id="L301">        mProxyHost = host;</span>
<span class="nc" id="L302">    }</span>

    /**
     * Get the proxy port number.
     * @return Returns the proxy port.
     */
    public int getProxyPort ()
    {
<span class="nc" id="L310">        return (mProxyPort);</span>
    }

    /**
     * Set the proxy port number.
     * @param port The proxy port.
     * &lt;em&gt;Note: You must also set the proxy {@link #setProxyHost host}.&lt;/em&gt;
     */
    public void setProxyPort (int port)
    {
<span class="nc" id="L320">        mProxyPort = port;</span>
<span class="nc" id="L321">    }</span>

    /**
     * Get the user name for proxy authorization, if any.
     * @return Returns the proxy user,
     * or &lt;code&gt;null&lt;/code&gt; if no proxy authorization is required.
     */
    public String getProxyUser ()
    {
<span class="fc" id="L330">        return (mProxyUser);</span>
    }

    /**
     * Set the user name for proxy authorization.
     * @param user The proxy user name.
     * &lt;em&gt;Note: You must also set the proxy {@link #setProxyPassword password}.&lt;/em&gt;
     */
    public void setProxyUser (String user)
    {
<span class="nc" id="L340">        mProxyUser = user;</span>
<span class="nc" id="L341">    }</span>

    /**
     * Set the proxy user's password.
     * @return Returns the proxy password.
     */
    public String getProxyPassword ()
    {
<span class="nc" id="L349">        return (mProxyPassword);</span>
    }

    /**
     * Get the proxy user's password.
     * @param password The password for the proxy user.
     * &lt;em&gt;Note: You must also set the proxy {@link #setProxyUser user}.&lt;/em&gt;
     */
    public void setProxyPassword (String password)
    {
<span class="nc" id="L359">        mProxyPassword = password;</span>
<span class="nc" id="L360">    }</span>

    /**
     * Get the user name to access the URL.
     * @return Returns the username that will be used to access the URL,
     * or &lt;code&gt;null&lt;/code&gt; if no authorization is required.
     */
    public String getUser ()
    {
<span class="fc" id="L369">        return (mUser);</span>
    }

    /**
     * Set the user name to access the URL.
     * @param user The user name for accessing the URL.
     * &lt;em&gt;Note: You must also set the {@link #setPassword password}.&lt;/em&gt;
     */
    public void setUser (String user)
    {
<span class="nc" id="L379">        mUser = user;</span>
<span class="nc" id="L380">    }</span>

    /**
     * Get the URL users's password.
     * @return Returns the URL password.
     */
    public String getPassword ()
    {
<span class="nc" id="L388">        return (mPassword);</span>
    }

    /**
     * Set the URL users's password.
     * @param password The password for the URL.
     */
    public void setPassword (String password)
    {
<span class="nc" id="L397">        mPassword = password;</span>
<span class="nc" id="L398">    }</span>

    /**
     * Predicate to determine if cookie processing is currently enabled.
     * @return &lt;code&gt;true&lt;/code&gt; if cookies are being processed.
     */
    public boolean getCookieProcessingEnabled ()
    {
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">        return (null != mCookieJar);</span>
    }

    /**
     * Enables and disabled cookie processing.
     * @param enable if &lt;code&gt;true&lt;/code&gt; cookie processing will occur,
     * else cookie processing will be turned off.
     */
    public void setCookieProcessingEnabled (boolean enable)
    {
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (enable)</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            mCookieJar = (null == mCookieJar) ? new Hashtable () : mCookieJar;</span>
        else
<span class="nc" id="L419">            mCookieJar = null;</span>
<span class="nc" id="L420">    }</span>

    /**
     * Adds a cookie to the cookie jar.
     * @param cookie The cookie to add.
     * @param domain The domain to use in case the cookie has no domain attribute.
     */
    public void setCookie (Cookie cookie, String domain)
    {
        String path;
        Vector cookies;
        Cookie probe;
        boolean found; // flag if a cookie with current name is already there

<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (null != cookie.getDomain ())</span>
<span class="nc" id="L435">            domain = cookie.getDomain ();</span>
<span class="nc" id="L436">        path = cookie.getPath ();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (null == mCookieJar)</span>
<span class="nc" id="L438">            mCookieJar = new Hashtable (); // turn on cookie processing</span>
<span class="nc" id="L439">        cookies = (Vector)mCookieJar.get (domain);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (null != cookies)</span>
        {
<span class="nc" id="L442">            found = false;</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">            for (int j = 0; j &lt; cookies.size (); j++)</span>
            {
<span class="nc" id="L445">                probe = (Cookie)cookies.elementAt (j);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                if (probe.getName ().equalsIgnoreCase (cookie.getName ()))</span>
                {
                    // we keep paths sorted most specific to least
<span class="nc bnc" id="L449" title="All 2 branches missed.">                    if (probe.getPath ().equals (path))</span>
                    {
<span class="nc" id="L451">                        cookies.setElementAt (cookie, j); // replace</span>
<span class="nc" id="L452">                        found = true; // cookie found, set flag</span>
<span class="nc" id="L453">                        break;</span>
                    }
<span class="nc bnc" id="L455" title="All 2 branches missed.">                    else if (path.startsWith (probe.getPath ()))</span>
                    {
<span class="nc" id="L457">                        cookies.insertElementAt (cookie, j);</span>
<span class="nc" id="L458">                        found = true; // cookie found, set flag</span>
<span class="nc" id="L459">                        break;</span>
                    }
                }
            }
<span class="nc bnc" id="L463" title="All 2 branches missed.">            if (!found)</span>
                // there's no cookie with the current name, therefore it's added
                // at the end of the list (faster then inserting at the front)
<span class="nc" id="L466">                cookies.addElement (cookie);</span>
<span class="nc" id="L467">        }</span>
        else
        {   // new cookie list needed
<span class="nc" id="L470">            cookies = new Vector ();</span>
<span class="nc" id="L471">            cookies.addElement (cookie);</span>
<span class="nc" id="L472">            mCookieJar.put (domain, cookies);</span>
        }
<span class="nc" id="L474">    }</span>

    /**
     * Get the monitoring object, if any.
     * @return Returns the monitor, or null if none has been assigned.
     */
    public ConnectionMonitor getMonitor ()
    {
<span class="fc" id="L482">        return (mMonitor);</span>
    }

    /**
     * Set the monitoring object.
     * @param monitor The monitor to set.
     */
    public void setMonitor (ConnectionMonitor monitor)
    {
<span class="nc" id="L491">        mMonitor = monitor;</span>
<span class="nc" id="L492">    }</span>

    /**
     * Predicate to determine if url redirection processing is currently enabled.
     * @return &lt;code&gt;true&lt;/code&gt; if redirection is being processed manually.
     * @see #setRedirectionProcessingEnabled
     */
    public boolean getRedirectionProcessingEnabled ()
    {
<span class="fc" id="L501">        return (mRedirectionProcessingEnabled);</span>
    }

    /**
     * Enables or disables manual redirection handling.
     * Normally the &lt;code&gt;HttpURLConnection&lt;/code&gt; follows redirections
     * (HTTP response code 3xx) automatically if the
     * &lt;code&gt;followRedirects&lt;/code&gt; property is &lt;code&gt;true&lt;/code&gt;.
     * With this flag set the &lt;code&gt;ConnectionMonitor&lt;/code&gt; performs the
     * redirection processing; The advantage being that cookies (if enabled)
     * are passed in subsequent requests.
     * @param enabled The new state of the redirectionProcessingEnabled property.
     */
    public void setRedirectionProcessingEnabled (boolean enabled)
    {
<span class="nc" id="L516">        mRedirectionProcessingEnabled = enabled;</span>
<span class="nc" id="L517">    }</span>

    /**
     * Get the Location field if any.
     * @param http The connection to get the location from.
     */
    protected String getLocation (HttpURLConnection http)
    {
        String key;
        String value;
        String ret;

<span class="nc" id="L529">        ret = null;</span>

<span class="nc bnc" id="L531" title="All 4 branches missed.">        for (int i = 0; ((null == ret) &amp;&amp; (null != (value = http.getHeaderField (i)))); i++)</span>
<span class="nc bnc" id="L532" title="All 4 branches missed.">            if ((null != (key = http.getHeaderFieldKey (i))) &amp;&amp; (key.equalsIgnoreCase (&quot;Location&quot;)))</span>
<span class="nc" id="L533">                ret = value;</span>

<span class="nc" id="L535">        return (ret);</span>
    }

    /**
     * Opens a connection using the given url.
     * @param url The url to open.
     * @return The connection.
     * @exception ParserException if an i/o exception occurs accessing the url.
     */
    public URLConnection openConnection (URL url)
        throws
            ParserException
    {
        boolean repeat;
        int repeated;
        Properties sysprops;
        Hashtable properties;
        Enumeration enumeration;
        String key;
        String value;
<span class="fc" id="L555">        String set = null; // old proxySet value</span>
<span class="fc" id="L556">        String host = null; // old proxyHost value</span>
<span class="fc" id="L557">        String port = null; // old proxyPort value</span>
<span class="fc" id="L558">        String host2 = null; // old http.proxyHost value</span>
<span class="fc" id="L559">        String port2 = null; // old http.proxyPort value</span>
        HttpURLConnection http;
        String auth;
        String encoded;
        int code;
        String uri;
        URLConnection ret;

<span class="fc" id="L567">        repeated = 0;</span>
        do
        {
<span class="fc" id="L570">            repeat = false;</span>
            try
            {
                try
                {
                    // set up for proxy
<span class="pc bpc" id="L576" title="3 of 4 branches missed.">                    if ((null != getProxyHost ()) &amp;&amp; (0 != getProxyPort ()))</span>
                    {
<span class="nc" id="L578">                        sysprops = System.getProperties ();</span>
<span class="nc" id="L579">                        set = (String)sysprops.put (&quot;proxySet&quot;, &quot;true&quot;);</span>
<span class="nc" id="L580">                        host = (String)sysprops.put (&quot;proxyHost&quot;, getProxyHost ());</span>
<span class="nc" id="L581">                        port = (String)sysprops.put (&quot;proxyPort&quot;,</span>
<span class="nc" id="L582">                            Integer.toString (getProxyPort ()));</span>
                        // see http://java.sun.com/j2se/1.4.2/docs/guide/net/properties.html
<span class="nc" id="L584">                        host2 = (String)sysprops.put (&quot;http.proxyHost&quot;,</span>
<span class="nc" id="L585">                            getProxyHost ());</span>
<span class="nc" id="L586">                        port2 = (String)sysprops.put (&quot;http.proxyPort&quot;,</span>
<span class="nc" id="L587">                            Integer.toString (getProxyPort ()));</span>
<span class="nc" id="L588">                        System.setProperties (sysprops);</span>

                    }

                    // open the connection... but don't connect yet
<span class="fc" id="L593">                    ret = url.openConnection ();</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">                    if (ret instanceof HttpURLConnection)</span>
                    {
<span class="fc" id="L596">                        http = (HttpURLConnection)ret;</span>

<span class="pc bpc" id="L598" title="1 of 2 branches missed.">                        if (getRedirectionProcessingEnabled ())</span>
<span class="nc" id="L599">                            http.setInstanceFollowRedirects (false);</span>

                        // set the fixed request properties
<span class="fc" id="L602">                        properties = getRequestProperties ();</span>
<span class="pc bpc" id="L603" title="1 of 2 branches missed.">                        if (null != properties)</span>
<span class="fc" id="L604">                            for (enumeration = properties.keys ();</span>
<span class="fc bfc" id="L605" title="All 2 branches covered.">                                    enumeration.hasMoreElements ();)</span>
                            {
<span class="fc" id="L607">                                key = (String)enumeration.nextElement ();</span>
<span class="fc" id="L608">                                value = (String)properties.get (key);</span>
<span class="fc" id="L609">                                ret.setRequestProperty (key, value);</span>
                            }

                        // set the proxy name and password
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">                        if ((null != getProxyUser ())</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                            &amp;&amp; (null != getProxyPassword ()))</span>
                        {
<span class="nc" id="L616">                            auth = getProxyUser () + &quot;:&quot; + getProxyPassword ();</span>
<span class="nc" id="L617">                            encoded = encode (auth.getBytes(&quot;ISO-8859-1&quot;));</span>
<span class="nc" id="L618">                            ret.setRequestProperty (&quot;Proxy-Authorization&quot;, encoded);</span>
                        }

                        // set the URL name and password
<span class="pc bpc" id="L622" title="3 of 4 branches missed.">                        if ((null != getUser ()) &amp;&amp; (null != getPassword ()))</span>
                        {
<span class="nc" id="L624">                            auth = getUser () + &quot;:&quot; + getPassword ();</span>
<span class="nc" id="L625">                            encoded = encode (auth.getBytes(&quot;ISO-8859-1&quot;));</span>
<span class="nc" id="L626">                            ret.setRequestProperty (&quot;Authorization&quot;,</span>
<span class="nc" id="L627">                                &quot;Basic &quot; + encoded);</span>
                        }

<span class="pc bpc" id="L630" title="1 of 2 branches missed.">                        if (getCookieProcessingEnabled ())</span>
                            // set the cookies based on the url
<span class="nc" id="L632">                            addCookies (ret);</span>

<span class="pc bpc" id="L634" title="1 of 2 branches missed.">                        if (null != getMonitor ())</span>
<span class="nc" id="L635">                            getMonitor ().preConnect (http);</span>
<span class="nc" id="L636">                    }</span>
                    else
<span class="fc" id="L638">                        http = null;</span>

                    try
                    {
<span class="fc" id="L642">                        ret.connect ();</span>

<span class="pc bpc" id="L644" title="1 of 2 branches missed.">                        if (null != http)</span>
                        {
<span class="nc bnc" id="L646" title="All 2 branches missed.">                            if (null != getMonitor ())</span>
<span class="nc" id="L647">                                getMonitor ().postConnect (http);</span>

<span class="nc bnc" id="L649" title="All 2 branches missed.">                            if (getCookieProcessingEnabled ())</span>
<span class="nc" id="L650">                                parseCookies (ret);</span>

<span class="nc" id="L652">                            code = http.getResponseCode ();</span>
<span class="nc bnc" id="L653" title="All 4 branches missed.">                            if ((3 == (code / 100)) &amp;&amp; (repeated &lt; 20))</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                                if (null != (uri = getLocation (http)))</span>
                                {
<span class="nc" id="L656">                                    url = new URL (uri);</span>
<span class="nc" id="L657">                                    repeat = true;</span>
<span class="nc" id="L658">                                    repeated++;</span>
                                }
                        }
<span class="nc" id="L661">                    }</span>
<span class="fc" id="L662">                    catch (UnknownHostException uhe)</span>
                    {
<span class="fc" id="L664">                        int message = (int)(Math.random () * FOUR_OH_FOUR.length);</span>
<span class="fc" id="L665">                        throw new ParserException (FOUR_OH_FOUR[message], uhe);</span>
                    }
<span class="fc" id="L667">                    catch (IOException ioe)</span>
                    {
<span class="fc" id="L669">                        throw new ParserException (ioe.getMessage (), ioe);</span>
                    }
                }
                finally
<span class="fc" id="L673">                {</span>
<span class="pc bpc" id="L674" title="6 of 8 branches missed.">                    if ((null != getProxyHost ()) &amp;&amp; (0 != getProxyPort ()))</span>
                    {
<span class="nc" id="L676">                        sysprops = System.getProperties ();</span>
<span class="nc bnc" id="L677" title="All 4 branches missed.">                        if (null != set)</span>
<span class="nc" id="L678">                            sysprops.put (&quot;proxySet&quot;, set);</span>
                        else
<span class="nc" id="L680">                            sysprops.remove (&quot;proxySet&quot;);</span>
<span class="nc bnc" id="L681" title="All 4 branches missed.">                        if (null != host)</span>
<span class="nc" id="L682">                            sysprops.put (&quot;proxyHost&quot;, host);</span>
                        else
<span class="nc" id="L684">                            sysprops.remove (&quot;proxyHost&quot;);</span>
<span class="nc bnc" id="L685" title="All 4 branches missed.">                        if (null != port)</span>
<span class="nc" id="L686">                            sysprops.put (&quot;proxyPort&quot;, port);</span>
                        else
<span class="nc" id="L688">                            sysprops.remove (&quot;proxyPort&quot;);</span>
<span class="nc bnc" id="L689" title="All 4 branches missed.">                        if (null != host2)</span>
<span class="nc" id="L690">                            sysprops.put (&quot;http.proxyHost&quot;, host2);</span>
                        else
<span class="nc" id="L692">                            sysprops.remove (&quot;http.proxyHost&quot;);</span>
<span class="nc bnc" id="L693" title="All 4 branches missed.">                        if (null != port2)</span>
<span class="nc" id="L694">                            sysprops.put (&quot;http.proxyPort&quot;, port2);</span>
                        else
<span class="nc" id="L696">                            sysprops.remove (&quot;http.proxyPort&quot;);</span>
<span class="nc" id="L697">                        System.setProperties (sysprops);</span>
                    }
<span class="fc" id="L699">                }</span>
<span class="nc" id="L700">            }</span>
<span class="nc" id="L701">            catch (IOException ioe)</span>
            {
<span class="nc" id="L703">                String msg = &quot;Error in opening a connection to &quot;</span>
<span class="nc" id="L704">                    + url.toExternalForm ();</span>
<span class="nc" id="L705">                ParserException ex = new ParserException (msg, ioe);</span>
<span class="nc" id="L706">                throw ex;</span>
            }
        }
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">        while (repeat);</span>

<span class="fc" id="L711">        return (ret);</span>
    }

    /**
     * Encodes a byte array into BASE64 in accordance with
     * &lt;a href=&quot;http://www.faqs.org/rfcs/rfc2045.html&quot;&gt;RFC 2045&lt;/a&gt;.
     * @param array The bytes to convert.
     * @return A BASE64 encoded string.
     */
    public final static String encode (byte[] array)
    {
        int last; // last byte
        int count; // character count
        int separators; // line separator count
        int length; // length of returned string
        char[] encoded; // encoded characters
        int left; // bytes left
        int end;
        int block; // encoding buffer
        int r; // shift count
        int n; // byte to encode
        int index; // index into output array
        String ret;

<span class="nc bnc" id="L735" title="All 4 branches missed.">        if ((null != array) &amp;&amp; (0 != array.length))</span>
        {
<span class="nc" id="L737">            last = array.length - 1;</span>
<span class="nc" id="L738">            count = (last / 3 + 1) &lt;&lt; 2;</span>
<span class="nc" id="L739">            separators = (count - 1) / 76;</span>
<span class="nc" id="L740">            length = count + separators;</span>
<span class="nc" id="L741">            encoded = new char[length];</span>
<span class="nc" id="L742">            index = 0;</span>
<span class="nc" id="L743">            separators = 0;</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">            for (int i = 0; i &lt;= last; i += 3)</span>
            {
<span class="nc" id="L746">                left = last - i;</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">                end = (left &gt; 1 ? 2 : left);</span>
    
                // collect 1 to 3 bytes to encode
<span class="nc" id="L750">                block = 0;</span>
<span class="nc" id="L751">                r = 16;</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                for (int j = 0; j &lt;= end; j++)</span>
                {
<span class="nc" id="L754">                    n = array[i + j];</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">                    block += (n &lt; 0 ? n + 256 : n) &lt;&lt; r;</span>
<span class="nc" id="L756">                    r -= 8;</span>
                }
    
                // encode into 2-4 chars padding with '=' if no data left
<span class="nc" id="L760">                encoded[index++] = BASE64_CHAR_TABLE[(block &gt;&gt;&gt; 18) &amp; 0x3f];</span>
<span class="nc" id="L761">                encoded[index++] = BASE64_CHAR_TABLE[(block &gt;&gt;&gt; 12) &amp; 0x3f];</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                encoded[index++] = left &gt; 0 ?</span>
<span class="nc" id="L763">                    BASE64_CHAR_TABLE[(block &gt;&gt;&gt; 6) &amp; 0x3f] :</span>
<span class="nc" id="L764">                    '=';</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">                encoded[index++] = left &gt; 1 ?</span>
<span class="nc" id="L766">                    BASE64_CHAR_TABLE[block &amp; 0x3f] :</span>
<span class="nc" id="L767">                    '=';</span>
    
<span class="nc bnc" id="L769" title="All 4 branches missed.">                if ((0 == (index - separators) % 76) &amp;&amp; (index &lt; length))</span>
                {
<span class="nc" id="L771">                    encoded[index++] = '\n';</span>
<span class="nc" id="L772">                    separators += 1;</span>
                }
            }
<span class="nc" id="L775">            ret = new String (encoded);</span>
<span class="nc" id="L776">        }</span>
        else
<span class="nc" id="L778">            ret = &quot;&quot;;</span>

<span class="nc" id="L780">        return (ret);</span>
    }

    /**
     * Turn spaces into %20.
     * ToDo: make this more generic
     * (see RFE #1010593 provide URL encoding/decoding utilities).
     * @param url The url containing spaces.
     * @return The URL with spaces as %20 sequences.
     */
    public String fixSpaces (String url)
    {
        int index;
        int length;
        char ch;
        StringBuffer buffer;

<span class="fc" id="L797">        index = url.indexOf (' ');</span>
<span class="fc bfc" id="L798" title="All 2 branches covered.">        if (-1 != index)</span>
        {
<span class="fc" id="L800">            length = url.length ();</span>
<span class="fc" id="L801">            buffer = new StringBuffer (length * 3);</span>
<span class="fc" id="L802">            buffer.append (url.substring (0, index));</span>
<span class="fc bfc" id="L803" title="All 2 branches covered.">            for (int i = index; i &lt; length; i++)</span>
            {
<span class="fc" id="L805">                ch = url.charAt (i);</span>
<span class="fc bfc" id="L806" title="All 2 branches covered.">                if (ch==' ')</span>
<span class="fc" id="L807">                    buffer.append (&quot;%20&quot;);</span>
                else
<span class="fc" id="L809">                    buffer.append (ch);</span>
            }
<span class="fc" id="L811">            url = buffer.toString ();</span>
        }

<span class="fc" id="L814">        return (url);</span>
    }

    /**
     * Opens a connection based on a given string.
     * The string is either a file, in which case &lt;code&gt;file://localhost&lt;/code&gt;
     * is prepended to a canonical path derived from the string, or a url that
     * begins with one of the known protocol strings, i.e. &lt;code&gt;http://&lt;/code&gt;.
     * Embedded spaces are silently converted to %20 sequences.
     * @param string The name of a file or a url.
     * @return The connection.
     * @exception ParserException if the string is not a valid url or file.
     */
    public URLConnection openConnection (String string)
        throws
            ParserException
    {
<span class="fc" id="L831">        final String prefix = &quot;file://localhost&quot;;</span>
        String resource;
        URL url;
        StringBuffer buffer;
        URLConnection ret;

        try
        {
<span class="nc" id="L839">            url = new URL (fixSpaces (string));</span>
<span class="nc" id="L840">            ret =  openConnection (url);</span>
<span class="nc" id="L841">        }</span>
<span class="fc" id="L842">        catch (MalformedURLException murle)</span>
        {   // try it as a file
            try
            {
<span class="fc" id="L846">                File file = new File (string);</span>
<span class="fc" id="L847">                resource = file.getCanonicalPath ();</span>
<span class="fc" id="L848">                buffer = new StringBuffer (prefix.length ()</span>
<span class="fc" id="L849">                    + resource.length ());</span>
<span class="fc" id="L850">                buffer.append (prefix);</span>
<span class="pc bpc" id="L851" title="1 of 2 branches missed.">                if (!resource.startsWith (&quot;/&quot;))</span>
<span class="nc" id="L852">                    buffer.append (&quot;/&quot;);</span>
<span class="fc" id="L853">                buffer.append (resource);</span>
<span class="fc" id="L854">                url = new URL (fixSpaces (buffer.toString ()));</span>
<span class="fc" id="L855">                ret = openConnection (url);</span>
<span class="fc" id="L856">            }</span>
<span class="nc" id="L857">            catch (MalformedURLException murle2)</span>
            {
<span class="nc" id="L859">                String msg = &quot;Error in opening a connection to &quot; + string;</span>
<span class="nc" id="L860">                ParserException ex = new ParserException (msg, murle2);</span>
<span class="nc" id="L861">                throw ex;</span>
            }
<span class="nc" id="L863">            catch (IOException ioe)</span>
            {
<span class="nc" id="L865">                String msg = &quot;Error in opening a connection to &quot; + string;</span>
<span class="nc" id="L866">                ParserException ex = new ParserException (msg, ioe);</span>
<span class="nc" id="L867">                throw ex;</span>
            }
        }

<span class="fc" id="L871">        return (ret);</span>
    }

    /**
     * Generate a HTTP cookie header value string from the cookie jar.
     * &lt;pre&gt;
     *   The syntax for the header is:
     *
     *    cookie          =       &quot;Cookie:&quot; cookie-version
     *                            1*((&quot;;&quot; | &quot;,&quot;) cookie-value)
     *    cookie-value    =       NAME &quot;=&quot; VALUE [&quot;;&quot; path] [&quot;;&quot; domain]
     *    cookie-version  =       &quot;$Version&quot; &quot;=&quot; value
     *    NAME            =       attr
     *    VALUE           =       value
     *    path            =       &quot;$Path&quot; &quot;=&quot; value
     *    domain          =       &quot;$Domain&quot; &quot;=&quot; value
     *
     * &lt;/pre&gt;
     * @param connection The connection being accessed.
     * @see &lt;a href=&quot;http://www.ietf.org/rfc/rfc2109.txt&quot;&gt;RFC 2109&lt;/a&gt;
     * @see &lt;a href=&quot;http://www.ietf.org/rfc/rfc2396.txt&quot;&gt;RFC 2396&lt;/a&gt;
     */
    public void addCookies (URLConnection connection)
    {
        Vector list;
        URL url;
        String host;
        String path;
        String domain;

<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (null != mCookieJar)</span>
        {
<span class="nc" id="L903">            list = null;</span>
            // get the site from the URL
<span class="nc" id="L905">            url = connection.getURL ();</span>
<span class="nc" id="L906">            host = url.getHost ();</span>
<span class="nc" id="L907">            path = url.getPath ();</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">            if (0 == path.length ())</span>
<span class="nc" id="L909">                path = &quot;/&quot;;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">            if (null != host)</span>
            {   // http://www.objectsdevelopment.com/portal/modules/freecontent/content/javawebserver.html
<span class="nc" id="L912">                list = addCookies ((Vector)mCookieJar.get (host), path, list);</span>
<span class="nc" id="L913">                domain = getDomain (host);</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">                if (null != domain)</span>
<span class="nc" id="L915">                    list = addCookies ((Vector)mCookieJar.get (domain),</span>
<span class="nc" id="L916">                        path, list);</span>
                else
                    // maybe it is the domain we're accessing
<span class="nc" id="L919">                    list = addCookies ((Vector)mCookieJar.get (&quot;.&quot; + host),</span>
<span class="nc" id="L920">                        path, list);</span>
            }
<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (null != list)</span>
<span class="nc" id="L923">                connection.setRequestProperty (&quot;Cookie&quot;,</span>
<span class="nc" id="L924">                    generateCookieProperty (list));</span>
        }
<span class="nc" id="L926">    }</span>

    /**
     * Add qualified cookies from cookies into list.
     * @param cookies The list of cookies to check (may be null).
     * @param path The path being accessed.
     * @param list The list of qualified cookies.
     * @return The list of qualified cookies.
     */
    protected Vector addCookies (Vector cookies, String path, Vector list)
    {
        Cookie cookie;
        Date expires;
        Date now;

<span class="nc bnc" id="L941" title="All 2 branches missed.">        if (null != cookies)</span>
        {
<span class="nc" id="L943">            now = new Date ();</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">            for (int i = 0; i &lt; cookies.size (); i++)</span>
            {
<span class="nc" id="L946">                cookie = (Cookie)cookies.elementAt (i);</span>
<span class="nc" id="L947">                expires = cookie.getExpiryDate ();</span>
<span class="nc bnc" id="L948" title="All 4 branches missed.">                if ((null != expires) &amp;&amp; expires.before (now))</span>
                {
<span class="nc" id="L950">                    cookies.remove (i);</span>
<span class="nc" id="L951">                    i--; // dick with the loop variable</span>
<span class="nc" id="L952">                }</span>
                else
<span class="nc bnc" id="L954" title="All 2 branches missed.">                    if (path.startsWith (cookie.getPath ()))</span>
                    {
<span class="nc bnc" id="L956" title="All 2 branches missed.">                        if (null == list)</span>
<span class="nc" id="L957">                            list = new Vector ();</span>
<span class="nc" id="L958">                        list.addElement (cookie);</span>
                    }
            }
        }
        
<span class="nc" id="L963">        return (list);</span>
    }

    /**
     * Get the domain from a host.
     * @param host The supposed host name.
     * @return The domain (with the leading dot),
     * or null if the domain cannot be determined.
     */
    protected String getDomain (String host)
    {
        StringTokenizer tokenizer;
        int count;
        String server;
        int length;
        boolean ok;
        char c;
        String ret;
        
<span class="nc" id="L982">        ret = null;</span>
        
<span class="nc" id="L984">        tokenizer = new StringTokenizer (host, &quot;.&quot;);</span>
<span class="nc" id="L985">        count = tokenizer.countTokens ();</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">        if (3 &lt;= count)</span>
        {
            // have at least two dots,
            // check if we were handed an IP address by mistake
<span class="nc" id="L990">            length = host.length ();</span>
<span class="nc" id="L991">            ok = false;</span>
<span class="nc bnc" id="L992" title="All 4 branches missed.">            for (int i = 0; i &lt; length &amp;&amp; !ok; i++)</span>
            {
<span class="nc" id="L994">                c = host.charAt (i);</span>
<span class="nc bnc" id="L995" title="All 4 branches missed.">                if (!(Character.isDigit (c) || (c == '.')))</span>
<span class="nc" id="L996">                    ok = true;</span>
            }
<span class="nc bnc" id="L998" title="All 2 branches missed.">            if (ok)</span>
            {
                // so take everything after the first token
<span class="nc" id="L1001">                server = tokenizer.nextToken ();</span>
<span class="nc" id="L1002">                length = server.length ();</span>
<span class="nc" id="L1003">                ret = host.substring (length);</span>
            }
        }

<span class="nc" id="L1007">        return (ret);</span>
    }

    /**
     * Creates the cookie request property value from the list of
     * valid cookies for the domain.
     * @param cookies The list of valid cookies to be encoded in the request.
     * @return A string suitable for inclusion as the value of
     * the &quot;Cookie:&quot; request property.
     */
    protected String generateCookieProperty (Vector cookies)
    {
        int version;
        Cookie cookie;
        StringBuffer buffer;
        String ret;
        
<span class="nc" id="L1024">        ret = null;</span>

<span class="nc" id="L1026">        buffer = new StringBuffer ();</span>
<span class="nc" id="L1027">        version = 0;</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">        for (int i = 0; i &lt; cookies.size (); i++)</span>
<span class="nc" id="L1029">            version = Math.max (version,</span>
<span class="nc" id="L1030">                ((Cookie)cookies.elementAt (i)).getVersion ());</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">        if (0 != version)</span>
        {
<span class="nc" id="L1033">            buffer.append (&quot;$Version=\&quot;&quot;);</span>
<span class="nc" id="L1034">            buffer.append (version);</span>
<span class="nc" id="L1035">            buffer.append (&quot;\&quot;&quot;);</span>
        }
<span class="nc bnc" id="L1037" title="All 2 branches missed.">        for (int i = 0; i &lt; cookies.size (); i++)</span>
        {
<span class="nc" id="L1039">            cookie = (Cookie)cookies.elementAt (i);</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">            if (0 != buffer.length ())</span>
<span class="nc" id="L1041">                buffer.append (&quot;; &quot;);</span>
<span class="nc" id="L1042">            buffer.append (cookie.getName ());</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">            buffer.append (cookie.getName ().equals (&quot;&quot;) ? &quot;&quot; : &quot;=&quot;);</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">            if (0 != version)</span>
<span class="nc" id="L1045">                buffer.append (&quot;\&quot;&quot;);</span>
<span class="nc" id="L1046">            buffer.append (cookie.getValue ());</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">            if (0 != version)</span>
<span class="nc" id="L1048">                buffer.append (&quot;\&quot;&quot;);</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">            if (0 != version)</span>
            {
<span class="nc bnc" id="L1051" title="All 2 branches missed.">                if ((null != cookie.getPath ())</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">                    &amp;&amp; (0 != cookie.getPath ().length ()))</span>
                {
<span class="nc" id="L1054">                    buffer.append (&quot;; $Path=\&quot;&quot;);</span>
<span class="nc" id="L1055">                    buffer.append (cookie.getPath ());</span>
<span class="nc" id="L1056">                    buffer.append (&quot;\&quot;&quot;);</span>
                }
<span class="nc bnc" id="L1058" title="All 2 branches missed.">                if ((null != cookie.getDomain ())</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">                    &amp;&amp; (0 != cookie.getDomain ().length ()))</span>
                {
<span class="nc" id="L1061">                    buffer.append (&quot;; $Domain=\&quot;&quot;);</span>
<span class="nc" id="L1062">                    buffer.append (cookie.getDomain ());</span>
<span class="nc" id="L1063">                    buffer.append (&quot;\&quot;&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        if (0 != buffer.length ())</span>
<span class="nc" id="L1068">            ret = buffer.toString ();</span>

<span class="nc" id="L1070">        return (ret);</span>
    }
    
    /**
     * Check for cookie and parse into cookie jar.
     * @param connection The connection to extract cookie information from.
     */
    public void parseCookies (URLConnection connection)
    {
        String string;
        Vector cookies;
        StringTokenizer tokenizer;
        String token;
        int index;
        String name;
        String key;
        String value;
        Cookie cookie;
        
<span class="nc" id="L1089">        string = connection.getHeaderField (&quot;Set-Cookie&quot;);</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">        if (null != string)</span>
        {
//            set-cookie      =       &quot;Set-Cookie:&quot; cookies
//            cookies         =       1#cookie
//            cookie          =       NAME &quot;=&quot; VALUE *(&quot;;&quot; cookie-av)
//            NAME            =       attr
//            VALUE           =       value
//            cookie-av       =       &quot;Comment&quot; &quot;=&quot; value
//                            |       &quot;Domain&quot; &quot;=&quot; value
//                            |       &quot;Max-Age&quot; &quot;=&quot; value
//                            |       &quot;Path&quot; &quot;=&quot; value
//                            |       &quot;Secure&quot;
//                            |       &quot;Version&quot; &quot;=&quot; 1*DIGIT
<span class="nc" id="L1103">            cookies = new Vector ();</span>
<span class="nc" id="L1104">            tokenizer = new StringTokenizer (string, &quot;;,&quot;, true);</span>
<span class="nc" id="L1105">            cookie = null;</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">            while (tokenizer.hasMoreTokens ())</span>
            {
<span class="nc" id="L1108">                token = tokenizer.nextToken ().trim ();</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">                if (token.equals (&quot;;&quot;))</span>
<span class="nc" id="L1110">                    continue;</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">                else if (token.equals (&quot;,&quot;))</span>
                {
<span class="nc" id="L1113">                    cookie = null;</span>
<span class="nc" id="L1114">                    continue;</span>
                }
                    
<span class="nc" id="L1117">                index = token.indexOf ('=');</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">                if (-1 == index)</span>
                {
<span class="nc bnc" id="L1120" title="All 2 branches missed.">                    if (null == cookie)</span>
                    {   // an unnamed cookie
<span class="nc" id="L1122">                        name = &quot;&quot;;</span>
<span class="nc" id="L1123">                        value = token;</span>
<span class="nc" id="L1124">                        key = name;</span>
<span class="nc" id="L1125">                    }</span>
                    else
                    {
<span class="nc" id="L1128">                        name = token;</span>
<span class="nc" id="L1129">                        value = null;</span>
<span class="nc" id="L1130">                        key = name.toLowerCase ();</span>
                    }
<span class="nc" id="L1132">                }</span>
                else
                {
<span class="nc" id="L1135">                    name = token.substring (0, index);</span>
<span class="nc" id="L1136">                    value = token.substring (index + 1);</span>
<span class="nc" id="L1137">                    key = name.toLowerCase ();</span>
                }

<span class="nc bnc" id="L1140" title="All 2 branches missed.">                if (null == cookie)</span>
                {
                    try
                    {
<span class="nc" id="L1144">                        cookie = new Cookie (name, value);</span>
<span class="nc" id="L1145">                        cookies.addElement (cookie);</span>
<span class="nc" id="L1146">                    }</span>
<span class="nc" id="L1147">                    catch (IllegalArgumentException iae)</span>
                    {
                        // should print a warning
                        // for now just bail
<span class="nc" id="L1151">                        break;</span>
                    }
                }
                else
                {
<span class="nc bnc" id="L1156" title="All 2 branches missed.">                    if (key.equals (&quot;expires&quot;)) // Wdy, DD-Mon-YY HH:MM:SS GMT</span>
                    {
<span class="nc" id="L1158">                        String comma = tokenizer.nextToken ();</span>
<span class="nc" id="L1159">                        String rest = tokenizer.nextToken ();</span>
                        try
                        {
<span class="nc" id="L1162">                            Date date = mFormat.parse (value + comma + rest);</span>
<span class="nc" id="L1163">                            cookie.setExpiryDate (date);</span>
<span class="nc" id="L1164">                        }</span>
<span class="nc" id="L1165">                        catch (ParseException pe)</span>
                        {
                            // ok now what
<span class="nc" id="L1168">                            cookie.setExpiryDate (null);</span>
                        }
<span class="nc" id="L1170">                    }</span>
                    else
<span class="nc bnc" id="L1172" title="All 2 branches missed.">                        if (key.equals (&quot;domain&quot;))</span>
<span class="nc" id="L1173">                            cookie.setDomain (value);</span>
                        else
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                            if (key.equals (&quot;path&quot;))</span>
<span class="nc" id="L1176">                                cookie.setPath (value);</span>
                            else
<span class="nc bnc" id="L1178" title="All 2 branches missed.">                                if (key.equals (&quot;secure&quot;))</span>
<span class="nc" id="L1179">                                    cookie.setSecure (true);</span>
                                else
<span class="nc bnc" id="L1181" title="All 2 branches missed.">                                    if (key.equals (&quot;comment&quot;))</span>
<span class="nc" id="L1182">                                        cookie.setComment (value);</span>
                                    else
<span class="nc bnc" id="L1184" title="All 2 branches missed.">                                        if (key.equals (&quot;version&quot;))</span>
<span class="nc" id="L1185">                                            cookie.setVersion (</span>
<span class="nc" id="L1186">                                                Integer.parseInt (value));</span>
                                        else
<span class="nc bnc" id="L1188" title="All 2 branches missed.">                                            if (key.equals (&quot;max-age&quot;))</span>
                                            {
<span class="nc" id="L1190">                                                Date date = new Date ();</span>
<span class="nc" id="L1191">                                                long then = date.getTime ()</span>
<span class="nc" id="L1192">                                                + Integer.parseInt (value)</span>
<span class="nc" id="L1193">                                                * 1000;</span>
<span class="nc" id="L1194">                                                date.setTime (then);</span>
<span class="nc" id="L1195">                                                cookie.setExpiryDate (date);</span>
<span class="nc" id="L1196">                                            }</span>
                                            else
                                                // error,? unknown attribute,
                                                // maybe just another cookie
                                                // not separated by a comma
                                                try
                                                {
<span class="nc" id="L1203">                                                    cookie = new Cookie (name,</span>
<span class="nc" id="L1204">                                                        value);</span>
<span class="nc" id="L1205">                                                    cookies.addElement (cookie);</span>
<span class="nc" id="L1206">                                                }</span>
<span class="nc" id="L1207">                                                catch (IllegalArgumentException iae)</span>
                                                {
                                                    // should print a warning
                                                    // for now just bail
<span class="nc" id="L1211">                                                    break;</span>
                                                }
                }
           }
<span class="nc bnc" id="L1215" title="All 2 branches missed.">           if (0 != cookies.size ())</span>
<span class="nc" id="L1216">               saveCookies (cookies, connection);</span>
        }
<span class="nc" id="L1218">    }</span>

    /**
     * Save the cookies received in the response header.
     * @param list The list of cookies extracted from the response header.
     * @param connection The connection (used when a cookie has no domain).
     */
    protected void saveCookies (Vector list, URLConnection connection)
    {
        Cookie cookie;
        String domain;

<span class="nc bnc" id="L1230" title="All 2 branches missed.">        for (int i = 0; i &lt; list.size (); i++)</span>
        {
<span class="nc" id="L1232">            cookie = (Cookie)list.elementAt (i);</span>
<span class="nc" id="L1233">            domain = cookie.getDomain ();</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">            if (null == domain)</span>
<span class="nc" id="L1235">                domain = connection.getURL ().getHost ();</span>
<span class="nc" id="L1236">            setCookie (cookie, domain);</span>
        }
<span class="nc" id="L1238">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>AllTests (4) (Oct 27, 2015 3:17:09 PM)</div></body></html>